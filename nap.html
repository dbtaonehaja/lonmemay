<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nạp Tiền - VIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;500;600&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      :root {
        --bg-color: #0d1117;
        --panel-bg: rgba(22, 27, 34, 0.85);
        --accent-color: #00b4d8;
        --accent-glow: rgba(0, 180, 216, 0.6);
        --text-color: #f0f2f5;
        --text-color-secondary: #8892b0;
        --border-color: rgba(0, 180, 216, 0.2);
        --border-hover: rgba(0, 180, 216, 0.7);
        --shadow-color: rgba(0, 180, 216, 0.4);
        --success-color: #72ff6b;
        --success-glow: rgba(114, 255, 107, 0.6);
        --danger-color: #ff5e5e;
        --danger-glow: rgba(255, 94, 94, 0.5);
        --font-body: 'Poppins', sans-serif;
        --font-title: 'Orbitron', sans-serif;
        --font-mono: 'Fira Code', monospace;
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes neonPulse {
        0%, 100% { text-shadow: 0 0 5px var(--accent-glow), 0 0 10px var(--accent-glow); }
        50% { text-shadow: 0 0 2px var(--accent-glow), 0 0 5px var(--accent-glow); }
      }
      body {
        font-family: var(--font-body);
        background-color: var(--bg-color);
        background-image:
          radial-gradient(ellipse at top left, var(--accent-color) 0%, transparent 40%),
          radial-gradient(ellipse at bottom right, var(--danger-color) 0%, transparent 40%);
        background-blend-mode: overlay;
        background-size: 150% 150%;
        color: var(--text-color);
        display: flex; 
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 40px 20px; /* Thêm padding để tránh nội dung bị dính vào mép màn hình */
      }
      .transaction-container {
        width: 100%; max-width: 420px;
        padding: 40px; border-radius: 20px;
        backdrop-filter: blur(20px);
        background: rgba(22, 27, 34, 0.6);
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0,0,0,0.37);
        text-align: center;
        animation: fadeIn 0.8s ease-out;
        position: relative; /* Giữ relative cho back-button */
      }
      .back-button {
        position: absolute; top: 20px; left: 20px;
        color: var(--text-color-secondary);
        text-decoration: none;
        font-size: 24px;
        transition: color 0.3s ease;
      }
      .back-button:hover { color: var(--accent-color); }
      h2 {
        font-family: var(--font-title);
        font-size: 28px;
        text-transform: uppercase;
        color: var(--accent-color);
        text-shadow: 0 0 8px var(--accent-glow);
        animation: neonPulse 3s linear infinite alternate;
        letter-spacing: 2px;
        margin-bottom: 30px;
      }
      p.description {
        color: var(--text-color-secondary);
        font-size: 14px;
        margin-top: -15px;
        margin-bottom: 25px;
      }
      label {
        display: block; font-weight: 500;
        color: var(--text-color-secondary);
        margin-bottom: 10px; text-align: left;
        font-size: 15px;
      }
      .input-field {
        width: 100%; padding: 16px 20px;
        margin-bottom: 30px; border-radius: 12px;
        border: 2px solid var(--border-color);
        font-size: 18px;
        background: rgba(13, 17, 23, 0.5);
        color: var(--text-color);
        font-family: var(--font-mono);
        transition: all 0.3s ease;
        -moz-appearance: textfield;
      }
      .input-field:focus {
        border-color: var(--border-hover);
        box-shadow: 0 0 15px var(--shadow-color);
        outline: none;
      }
      input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
      .main-button {
        width: 100%; padding: 18px;
        margin-top: 15px; border-radius: 12px;
        border: none; font-weight: 700;
        font-family: var(--font-title);
        font-size: 18px; cursor: pointer;
        transition: all 0.3s ease;
        color: var(--bg-color); text-transform: uppercase;
        letter-spacing: 1px;
      }
      .main-button:hover { transform: translateY(-3px); }
      #continue-btn { background-color: var(--accent-color); box-shadow: 0 5px 20px -5px var(--shadow-color); }
      #continue-btn:hover { box-shadow: 0 8px 30px -5px var(--shadow-color); }
      #confirm-btn { 
          background-color: var(--success-color); 
          box-shadow: 0 5px 20px -5px var(--success-glow); 
          animation: neonPulse 2s infinite alternate;
          margin-bottom: 20px;
      }
      #confirm-btn:hover { box-shadow: 0 8px 30px -5px var(--success-glow); }
      .qr-image {
        max-width: 250px; width: 100%;
        border-radius: 16px; margin: 20px auto 25px;
        border: 3px solid #fff;
        box-shadow: 0 0 20px rgba(255,255,255,0.2);
        background: #fff;
      }
      .info-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 25px;
      }
      .info-line {
        background: rgba(13, 17, 23, 0.7);
        padding: 15px;
        border-radius: 10px;
        text-align: left;
        display: flex;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .info-content { flex-grow: 1; }
      .info-content span {
        color: var(--text-color-secondary);
        font-size: 13px;
        display: block;
        margin-bottom: 4px;
      }
      .info-content strong {
        color: var(--text-color);
        font-weight: 600;
        font-family: var(--font-mono);
        font-size: 1.1em;
      }
      .copy-btn {
          background: none;
          border: none;
          color: var(--text-color-secondary);
          cursor: pointer;
          font-size: 1.1em;
          transition: color 0.3s;
          margin-left: 10px;
      }
      .copy-btn:hover { color: var(--accent-color); }
      
      #step2-transfer-details { display: none; }
    </style>
</head>
<body>
    <div class="transaction-container">
        <a href="key.html" class="back-button" title="Quay lại"><i class="fas fa-arrow-left"></i></a>
        <div id="step1-amount-input">
            <h2>NẠP TIỀN</h2>
            <p class="description">Nhập số tiền bạn muốn nạp vào tài khoản.</p>
            <label for="amount"><i class="fas fa-money-bill-wave"></i> SỐ TIỀN CẦN NẠP</label>
            <input type="text" id="amount" class="input-field" placeholder="Tối thiểu 10.000" required>
            <button id="continue-btn" class="main-button">TIẾP TỤC</button>
        </div>
        <div id="step2-transfer-details">
            <h2>XÁC NHẬN GIAO DỊCH</h2>
            <p class="description">Quét mã hoặc chuyển khoản với thông tin dưới đây để tự động cộng tiền.</p>
            
            <button id="confirm-btn" class="main-button">TÔI ĐÃ CHUYỂN KHOẢN</button>
            
            <img src="https://i.postimg.cc/mD7GQPcd/IMG-20250918-000523.jpg" id="qr-image" alt="Mã QR Ngân hàng" class="qr-image">
            
            <div class="info-grid">
                <div class="info-line">
                    <div class="info-content">
                        <span>SỐ TIỀN</span>
                        <strong id="display-amount"></strong>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('display-amount')"><i class="fas fa-copy"></i></button>
                </div>
                <div class="info-line">
                    <div class="info-content">
                        <span>SỐ TÀI KHOẢN</span>
                        <strong id="account-number"></strong>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('account-number')"><i class="fas fa-copy"></i></button>
                </div>
                 <div class="info-line">
                    <div class="info-content">
                        <span>CHỦ TÀI KHOẢN</span>
                        <strong id="account-name"></strong>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('account-name')"><i class="fas fa-copy"></i></button>
                </div>
                <div class="info-line">
                    <div class="info-content">
                        <span>NỘI DUNG</span>
                        <strong id="transaction-content-text"></strong>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('transaction-content-text')"><i class="fas fa-copy"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAXtM_AHMeg76S0VaxQTJ_e68qKg0KxKRk",
            authDomain: "ma-my-7cb60.firebaseapp.com",
            projectId: "ma-my-7cb60",
            storageBucket: "ma-my-7cb60.firebasestorage.app",
            messagingSenderId: "139387264637",
            appId: "1:139387264637:web:5c296efe7d3bb97a2a5b14",
            measurementId: "G-E6RHBS10QV"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const swalConfig = {
            background: 'rgba(22, 27, 34, 0.95)',
            color: '#E6EDF3',
            confirmButtonColor: '#00b4d8',
            confirmButtonText: 'Đồng Ý',
        };
        
        const bankInfo = {
            accountNumber: "0329195729",
            accountName: "DTT",
        };

        let transactionId = '';
        let transactionAmount = 0;

        function generateTransactionId(username) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return `NAP${username.toUpperCase().substring(0, 5)}${result}`;
        }
        
        function formatCurrency(input) {
            let value = input.value.replace(/\./g, '');
            if (value === '' || isNaN(value)) {
                input.value = '';
                return;
            }
            value = parseInt(value, 10).toLocaleString('vi-VN');
            input.value = value.replace(/,/g, '.');
        }

        function copyToClipboard(elementId) {
            let textToCopy;
            const targetElement = document.getElementById(elementId);
            textToCopy = targetElement.textContent.trim();
            if (elementId === 'display-amount') {
                textToCopy = transactionAmount.toString();
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Đã sao chép!',
                    showConfirmButton: false,
                    timer: 1500,
                    ...swalConfig
                });
            }).catch(err => {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể sao chép.',
                    ...swalConfig
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const userInfo = JSON.parse(localStorage.getItem('tool_user_info'));
            if (!userInfo || !userInfo.username) { 
                Swal.fire({...swalConfig, title:'Lỗi', text:'Bạn cần đăng nhập để nạp tiền.', icon:'error'}).then(() => window.location.href = 'index.html'); 
                return; 
            }

            const step1 = document.getElementById('step1-amount-input');
            const step2 = document.getElementById('step2-transfer-details');
            const amountInput = document.getElementById('amount');
            const continueBtn = document.getElementById('continue-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            
            amountInput.addEventListener('input', () => formatCurrency(amountInput));

            continueBtn.addEventListener('click', async function() {
                const amountValueString = amountInput.value.replace(/\./g, '');
                const amountValue = parseInt(amountValueString, 10);
                if (isNaN(amountValue) || amountValue < 10000) { 
                    Swal.fire({...swalConfig, title:'Số tiền không hợp lệ!', text:'Vui lòng nhập số tiền tối thiểu là 10.000 VNĐ.', icon:'warning'}); 
                    return; 
                }

                transactionId = generateTransactionId(userInfo.username);
                transactionAmount = amountValue;

                document.getElementById('display-amount').textContent = transactionAmount.toLocaleString('vi-VN') + ' VNĐ';
                document.getElementById('account-number').textContent = bankInfo.accountNumber;
                document.getElementById('account-name').textContent = bankInfo.accountName;
                document.getElementById('transaction-content-text').textContent = transactionId;
                
                step1.style.display = 'none';
                step2.style.display = 'block';

                try {
                    await db.collection('deposit_requests').add({
                        username: userInfo.username,
                        amount: transactionAmount,
                        status: 'pending',
                        transactionId: transactionId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Lỗi khi gửi yêu cầu lên Firebase:", error);
                }
            });

            confirmBtn.addEventListener('click', function() {
                Swal.fire({
                    ...swalConfig,
                    title: 'Yêu Cầu Đã Gửi!',
                    text: 'Vui lòng chờ Admin duyệt giao dịch. Số dư của bạn sẽ được cộng tự động sau ít phút.',
                    icon: 'success'
                }).then(() => {
                    window.location.href = 'key.html';
                });
            });
        });
    </script>
</body>
</html>
