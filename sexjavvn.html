<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Lý</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;500;600&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-color: #0c0d12;
            --panel-bg: rgba(18, 20, 26, 0.7);
            --accent-color: #00b4d8;
            --accent-glow: rgba(0, 180, 216, 0.6);
            --text-color: #f0f2f5;
            --text-color-secondary: #8892b0;
            --border-color: rgba(0, 180, 216, 0.2);
            --success-color: #72ff6b;
            --danger-color: #ff5e5e;
            --warning-color: #ffc107;
            --font-body: 'Poppins', sans-serif;
            --font-title: 'Orbitron', sans-serif;
            --font-mono: 'Fira Code', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 5px var(--accent-glow), 0 0 10px var(--accent-glow); }
            50% { text-shadow: 0 0 2px var(--accent-glow), 0 0 5px var(--accent-glow); }
        }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            background-image:
              radial-gradient(ellipse at top left, var(--accent-color) 0%, transparent 40%),
              radial-gradient(ellipse at bottom right, var(--danger-color) 0%, transparent 40%);
            background-blend-mode: overlay;
            background-size: 150% 150%;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            padding: 30px;
            border-radius: 16px;
            backdrop-filter: blur(12px);
            background: var(--panel-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            animation: fadeIn 0.8s ease-out;
            position: relative;
        }
        h1, h2 {
            font-family: var(--font-title);
            text-align: center;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 25px;
            text-shadow: 0 0 8px var(--accent-glow);
        }
        h1 { font-size: 28px; }
        h2 { font-size: 24px; }
        input[type="password"] {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(13, 17, 23, 0.5);
            color: var(--text-color);
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="password"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-glow);
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: var(--bg-color);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .btn-login, .btn-refresh, .btn-primary { background-color: var(--accent-color); color: var(--bg-color); }
        .btn-login { width: 100%; }
        .btn-approve { background-color: var(--success-color); color: var(--bg-color); }
        .btn-reject { background-color: var(--danger-color); color: white; }
        .btn-delete-all { background-color: #555555; color: white; }
        .btn-edit { background-color: var(--warning-color); color: var(--bg-color); }
        .btn-deactivate { background-color: var(--danger-color); color: white; }
        button:hover { transform: translateY(-3px); box-shadow: 0 4px 15px -5px rgba(0, 0, 0, 0.5); }
        #status-message {
            text-align: center;
            padding: 10px;
            margin: 20px 0;
            border-radius: 6px;
            display: none;
            font-weight: 500;
        }
        .status-success { background-color: rgba(114, 255, 107, 0.2); color: var(--success-color); }
        .status-error { background-color: rgba(255, 94, 94, 0.2); color: var(--danger-color); }
        .status-loading { background-color: rgba(0, 180, 216, 0.2); color: var(--accent-color); }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            font-size: 15px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 15px;
            text-align: left;
            vertical-align: middle;
            word-break: break-all;
        }
        th {
            background-color: rgba(0, 180, 216, 0.1);
            color: var(--accent-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td { color: var(--text-color); }
        tr:hover { background-color: rgba(0, 180, 216, 0.05); }
        .actions-cell { text-align: center; white-space: nowrap; }
        .actions-cell button { margin: 5px; }
        .menu-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 28px;
            cursor: pointer;
            z-index: 10;
        }
        .menu-options {
            display: none;
            position: absolute;
            top: 60px;
            right: 25px;
            background-color: rgba(18, 20, 26, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            z-index: 9;
            animation: fadeIn 0.3s ease-out;
        }
        .menu-options button {
            display: block;
            width: 100%;
            text-align: left;
            margin: 5px 0;
            background: none;
            border: none;
            color: var(--text-color-secondary);
            font-weight: 500;
            padding: 10px 15px;
            transition: background-color 0.2s, color 0.2s;
            text-transform: none;
        }
        .menu-options button:hover {
            background-color: rgba(0, 180, 216, 0.2);
            color: var(--text-color);
            transform: none;
            box-shadow: none;
        }
        .status-active { color: var(--success-color); }
        .status-inactive { color: var(--danger-color); }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-end;
            align-items: center;
        }
        .btn-group .btn-refresh { margin-right: auto; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; }
            th, td { padding: 10px; font-size: 14px; }
            .actions-cell button { font-size: 12px; padding: 8px 10px; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

    <div class="container">
        <div id="login-screen">
            <h1><i class="fas fa-user-shield"></i> Admin Login</h1>
            <input type="password" id="admin-password" placeholder="Nhập mật khẩu admin...">
            <button onclick="login()" class="btn-login"><i class="fas fa-sign-in-alt"></i> Đăng Nhập</button>
        </div>

        <div id="admin-panel" style="display:none;">
            <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            <div id="menu-options" class="menu-options">
                <button onclick="showPanel('deposits')"><i class="fas fa-money-check-alt"></i> Duyệt Nạp Tiền</button>
                <button onclick="showPanel('users')"><i class="fas fa-users-cog"></i> Quản Lý Người Dùng</button>
            </div>

            <div id="deposits-panel">
                <h2>Bảng Chờ Duyệt Nạp Tiền</h2>
                <div class="btn-group">
                    <button onclick="fetchPendingDeposits()" class="btn-refresh"><i class="fas fa-sync-alt"></i> Tải Lại</button>
                    <button onclick="deleteAllDeposits()" class="btn-delete-all"><i class="fas fa-trash-alt"></i> Xóa Tất Cả</button>
                </div>
                <div id="status-message-deposits"></div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Mã GD</th>
                                <th>Username</th>
                                <th>Số Tiền</th>
                                <th class="actions-cell">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="deposits-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="users-panel" style="display:none;">
                <h2>Quản Lý Người Dùng</h2>
                <div class="btn-group">
                    <button onclick="fetchUsers()" class="btn-refresh"><i class="fas fa-sync-alt"></i> Tải Lại</button>
                    <button onclick="deleteAllUsers()" class="btn-delete-all"><i class="fas fa-trash-alt"></i> Xóa Tất Cả</button>
                </div>
                <div id="status-message-users"></div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Trạng thái</th>
                                <th>Hạn dùng</th>
                                <th>Số dư</th>
                                <th class="actions-cell">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="users-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAXtM_AHMeg76S0VaxQTJ_e68qKg0KxKRk",
        authDomain: "ma-my-7cb60.firebaseapp.com",
        projectId: "ma-my-7cb60",
        storageBucket: "ma-my-7cb60.firebasestorage.app",
        messagingSenderId: "139387264637",
        appId: "1:139387264637:web:5c296efe7d3bb97a2a5b14",
        measurementId: "G-E6RHBS10QV"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const ADMIN_PASSWORD = "deocotrinh";
    const swalConfig = {
        background: 'rgba(18, 20, 26, 0.95)',
        color: '#E6EDF3',
        confirmButtonColor: '#00b4d8',
    };

    const loginScreen = document.getElementById('login-screen');
    const adminPanel = document.getElementById('admin-panel');
    const depositsPanel = document.getElementById('deposits-panel');
    const usersPanel = document.getElementById('users-panel');
    const passwordInput = document.getElementById('admin-password');
    const depositsBody = document.getElementById('deposits-body');
    const usersBody = document.getElementById('users-body');
    const menuOptions = document.getElementById('menu-options');

    function showStatus(panel, message, type = 'loading') {
        const statusMessage = document.getElementById(`status-message-${panel}`);
        statusMessage.textContent = message;
        statusMessage.className = `status-${type}`;
        statusMessage.style.display = 'block';
    }

    function hideStatus(panel) {
        document.getElementById(`status-message-${panel}`).style.display = 'none';
    }

    function toggleMenu() {
        menuOptions.style.display = menuOptions.style.display === 'block' ? 'none' : 'block';
    }

    function showPanel(panelName) {
        depositsPanel.style.display = 'none';
        usersPanel.style.display = 'none';
        
        document.getElementById(`${panelName}-panel`).style.display = 'block';
        toggleMenu();
        if (panelName === 'deposits') {
            fetchPendingDeposits();
        } else {
            fetchUsers();
        }
    }

    function login() {
        if (passwordInput.value === ADMIN_PASSWORD) {
            loginScreen.style.display = 'none';
            adminPanel.style.display = 'block';
            showPanel('deposits');
        } else {
            Swal.fire({ ...swalConfig, title: 'Lỗi', text: 'Mật khẩu không chính xác!', icon: 'error' });
        }
    }

    async function fetchPendingDeposits() {
        showStatus('deposits', 'Đang tải danh sách...', 'loading');
        depositsBody.innerHTML = '';
        try {
            const snapshot = await db.collection('deposit_requests')
                .where('status', '==', 'pending')
                .orderBy('timestamp', 'asc')
                .get();
            const deposits = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                deposits.push({
                    id: doc.id,
                    timestamp: data.timestamp ? data.timestamp.toDate().toLocaleString('vi-VN') : 'N/A',
                    transactionId: data.transactionId,
                    username: data.username,
                    amount: data.amount.toLocaleString('vi-VN') + ' VNĐ'
                });
            });
            if (deposits.length === 0) {
                showStatus('deposits', '✅ Không có yêu cầu nào đang chờ duyệt.', 'success');
            } else {
                hideStatus('deposits');
                renderDeposits(deposits);
            }
        } catch (error) {
            showStatus('deposits', `Lỗi tải dữ liệu: ${error.message}`, 'error');
        }
    }

    function renderDeposits(deposits) {
        depositsBody.innerHTML = '';
        deposits.forEach(deposit => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${deposit.timestamp}</td>
                <td>${deposit.transactionId}</td>
                <td>${deposit.username}</td>
                <td>${deposit.amount}</td>
                <td class="actions-cell">
                    <button class="btn-approve" onclick="processDeposit('${deposit.id}', 'approve')">Duyệt</button>
                    <button class="btn-reject" onclick="processDeposit('${deposit.id}', 'reject')">Từ chối</button>
                </td>
            `;
            depositsBody.appendChild(row);
        });
    }

    async function deleteAllDeposits() {
        const result = await Swal.fire({
            ...swalConfig,
            title: 'Xóa Toàn Bộ?',
            text: 'Thao tác này sẽ xóa tất cả yêu cầu nạp tiền đang chờ duyệt. Bạn có chắc chắn không?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Xóa Hết',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#ff5e5e',
        });
        if (!result.isConfirmed) return;

        showStatus('deposits', 'Đang xóa toàn bộ...', 'loading');
        try {
            const batch = db.batch();
            const snapshot = await db.collection('deposit_requests')
                .where('status', '==', 'pending')
                .get();
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            Swal.fire({ ...swalConfig, title: 'Thành công!', text: 'Đã xóa toàn bộ yêu cầu đang chờ duyệt.', icon: 'success' });
            fetchPendingDeposits();
        } catch (error) {
            Swal.fire({ ...swalConfig, title: 'Lỗi', text: `Lỗi khi xóa: ${error.message}`, icon: 'error' });
        }
    }

    async function processDeposit(docId, type) {
        const result = await Swal.fire({
            ...swalConfig,
            title: `Xác nhận ${type === 'approve' ? 'Duyệt' : 'Từ chối'}`,
            text: `Bạn chắc chắn muốn ${type === 'approve' ? 'duyệt' : 'từ chối'} giao dịch này?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy',
            confirmButtonColor: type === 'approve' ? '#72ff6b' : '#ff5e5e',
        });
        if (!result.isConfirmed) return;
        showStatus('deposits', `Đang xử lý giao dịch...`, 'loading');
        try {
            const depositRef = db.collection('deposit_requests').doc(docId);
            const depositDoc = await depositRef.get();
            const depositData = depositDoc.data();
            if (type === 'approve') {
                const userRef = db.collection('users').doc(depositData.username);
                await db.runTransaction(async (t) => {
                    const userDoc = await t.get(userRef);
                    if (!userDoc.exists) { throw new Error("Không tìm thấy người dùng."); }
                    const newBalance = (userDoc.data().balance || 0) + depositData.amount;
                    t.update(userRef, { balance: newBalance });
                    t.update(depositRef, { 
                        status: 'completed',
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                Swal.fire({ ...swalConfig, title: 'Thành công!', text: `Đã duyệt và cộng tiền thành công cho ${depositData.username}!`, icon: 'success' });
            } else { 
                await depositRef.update({
                    status: 'rejected',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                Swal.fire({ ...swalConfig, title: 'Thành công!', text: `Đã từ chối giao dịch ${depositData.transactionId}.`, icon: 'info' });
            }
            fetchPendingDeposits(); 
        } catch (error) {
            Swal.fire({ ...swalConfig, title: 'Lỗi', text: `Lỗi xử lý: ${error.message}`, icon: 'error' });
        }
    }
    
    // =================================================================
    // Chức năng Quản lý người dùng
    // =================================================================

    async function fetchUsers() {
        showStatus('users', 'Đang tải danh sách người dùng...', 'loading');
        usersBody.innerHTML = '';
        try {
            const snapshot = await db.collection('users').get();
            const users = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                const expiryDate = data.expiryDate ? new Date(data.expiryDate.seconds * 1000).toLocaleString('vi-VN') : 'Vĩnh viễn';
                const status = data.isActive ? 'Đã kích hoạt' : 'Chưa kích hoạt';
                const statusClass = data.isActive ? 'status-active' : 'status-inactive';
                users.push({
                    id: doc.id,
                    username: data.username,
                    status,
                    statusClass,
                    expiryDate,
                    balance: data.balance || 0
                });
            });
            if (users.length === 0) {
                showStatus('users', '✅ Không có người dùng nào.', 'success');
            } else {
                hideStatus('users');
                renderUsers(users);
            }
        } catch (error) {
            showStatus('users', `Lỗi tải dữ liệu: ${error.message}`, 'error');
        }
    }

    function renderUsers(users) {
        usersBody.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.username}</td>
                <td><span class="${user.statusClass}">${user.status}</span></td>
                <td>${user.expiryDate}</td>
                <td>${user.balance.toLocaleString('vi-VN')} VNĐ</td>
                <td class="actions-cell">
                    <button class="btn-deactivate" onclick="deactivateUserKey('${user.id}')"><i class="fas fa-ban"></i> Vô hiệu hóa Key</button>
                    <button class="btn-edit" onclick="changeUserBalance('${user.id}')"><i class="fas fa-edit"></i> Sửa số dư</button>
                </td>
            `;
            usersBody.appendChild(row);
        });
    }

    async function deleteAllUsers() {
        const result = await Swal.fire({
            ...swalConfig,
            title: 'Xóa Toàn Bộ Người Dùng?',
            text: 'Thao tác này sẽ xóa tất cả người dùng trong hệ thống. Dữ liệu sẽ không thể khôi phục. Bạn có chắc chắn không?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Xóa Hết',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#ff5e5e',
        });
        if (!result.isConfirmed) return;

        showStatus('users', 'Đang xóa toàn bộ...', 'loading');
        try {
            const batch = db.batch();
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            Swal.fire({ ...swalConfig, title: 'Thành công!', text: 'Đã xóa toàn bộ người dùng.', icon: 'success' });
            fetchUsers();
        } catch (error) {
            Swal.fire({ ...swalConfig, title: 'Lỗi', text: `Lỗi khi xóa: ${error.message}`, icon: 'error' });
        }
    }

    async function deactivateUserKey(userId) {
        const result = await Swal.fire({
            ...swalConfig,
            title: 'Vô hiệu hóa Key',
            text: 'Thao tác này sẽ vô hiệu hóa key của tài khoản này. Người dùng sẽ cần kích hoạt lại để sử dụng.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#ff5e5e',
        });
        if (!result.isConfirmed) return;
        try {
            const userRef = db.collection('users').doc(userId);
            await userRef.update({
                isActive: false,
                expiryDate: null
            });
            Swal.fire({ ...swalConfig, title: 'Thành công!', text: 'Đã vô hiệu hóa key thành công!', icon: 'success' });
            fetchUsers();
        } catch (error) {
            Swal.fire({ ...swalConfig, title: 'Lỗi', text: `Lỗi xử lý: ${error.message}`, icon: 'error' });
        }
    }

    async function changeUserBalance(userId) {
        const { value: newBalance } = await Swal.fire({
            ...swalConfig,
            title: 'Nhập số dư mới',
            input: 'text',
            inputLabel: 'Số dư (VNĐ)',
            showCancelButton: true,
            confirmButtonText: 'Cập nhật',
            cancelButtonText: 'Hủy',
            inputValidator: (value) => {
                if (value === null || value.trim() === '' || isNaN(value)) {
                    return 'Vui lòng nhập một số hợp lệ!';
                }
            }
        });

        if (newBalance === undefined) return;
        try {
            const userRef = db.collection('users').doc(userId);
            await userRef.update({
                balance: parseInt(newBalance)
            });
            Swal.fire({ ...swalConfig, title: 'Thành công!', text: 'Đã cập nhật số dư thành công!', icon: 'success' });
            fetchUsers();
        } catch (error) {
            Swal.fire({ ...swalConfig, title: 'Lỗi', text: `Lỗi xử lý: ${error.message}`, icon: 'error' });
        }
    }

    passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            login();
        }
    });
</script>

</body>
</html>